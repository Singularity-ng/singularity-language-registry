#!/bin/bash

# Pre-push hook for Singularity Language Registry
# Final checks before pushing to remote

set -e

echo "üöÄ Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Check which branch we're pushing to
while read local_ref local_sha remote_ref remote_sha; do
    branch=$(echo "$remote_ref" | sed 's/refs\/heads\///')

    echo "üìç Pushing to branch: $branch"

    # Prevent direct push to main
    if [ "$branch" = "main" ]; then
        echo -e "${RED}‚ùå Direct push to main branch is not allowed!${NC}"
        echo -e "${YELLOW}Please create a pull request from development or a feature branch.${NC}"
        echo ""
        echo "Steps:"
        echo "1. git checkout -b feature/your-feature"
        echo "2. git push origin feature/your-feature"
        echo "3. Create a PR on GitHub"
        exit 1
    fi

    # Run comprehensive tests before push
    echo "üß™ Running comprehensive tests..."
    if ! cargo test --all-features --release; then
        echo -e "${RED}‚ùå Tests failed!${NC}"
        exit 1
    fi

    # Check for outdated dependencies
    echo "üì¶ Checking dependencies..."
    if command -v cargo-outdated &> /dev/null; then
        cargo outdated || true
    fi

    # Security audit
    echo "üîê Running security audit..."
    if command -v cargo-audit &> /dev/null; then
        if ! cargo audit; then
            echo -e "${YELLOW}‚ö†Ô∏è  Security vulnerabilities found!${NC}"
            echo "Consider fixing before pushing"
            read -p "Continue anyway? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi
    fi

    # Documentation check
    echo "üìö Checking documentation..."
    if ! cargo doc --all-features --no-deps; then
        echo -e "${RED}‚ùå Documentation build failed!${NC}"
        exit 1
    fi
done

echo -e "${GREEN}‚úÖ All pre-push checks passed!${NC}"